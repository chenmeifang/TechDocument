https://zhuanlan.zhihu.com/p/425284127

# 1.什么是OT算法

Operation Transformation

是在线协作系统中经常使用的操作合并算法

> OT算法是一种操作合并指导思想，是一类算法，在不同的应用场景下有不同实现。

# 2.为什么多人编辑需要OT算法

假设小贾和小王同时编辑一个文档，文档的初始内容是“123”

这时小贾先在123后面添加一个4，小王后在123后面添加一个5。 

如果没有合并算法，小贾本地文档的内容变化过程是：

1. 小贾把“123”改成了“1234”。
2. 接收到消息，小王在3后面加了一个5。
3. 小贾本地的字符串变成了“12354”。

小王本地文档的内容变化过程是：

1. 小王把“123”改成了“1235”。
2. 接收到消息，小贾在3后面加了一个4。
3. 小王本地的字符串变成了“12345”。

此时，小王看到的字符串是正确的，小贾看到的字符串是错误的。所以我们需要一种合并算法，保证小贾和小王看到的最终结果都正确。当更多人同时编辑文档时，需要所有人的本地操作结果都是正确的，OT算法刚好适用于解决此问题。

# 3.OT算法的重要思想

以下三个示例参考：[https://www3.ntu.edu.sg/scse/st](https://link.zhihu.com/?target=https%3A//www3.ntu.edu.sg/scse/staff/czsun/projects/otfaq/)

## 3.1 保持内容一致性的基本思想

![img](https://pic4.zhimg.com/80/v2-8d7ca66740cb45303ccb6982370f72d7_720w.webp)

如上图，两个用户在浏览器中打开了同一个在线文档，文档的初始内容是“123”。

1. 用户1和用户2同时操作，用户1的操作是`O1=Insert(0,"X")`，表示在位置0，插入字符串X；用户2的操作是`O2=Delete(2,1)`，表示从第二个位置开始删除元素，删除长度是1。
2. 用户1浏览器中字符串先变成“X123”，O2操作到达用户1的浏览器之后，和O1发生转换`O2'=Transform(O2,O1)= Delete(3,1)`，O2'虽然也是执行删除操作，但是因为O1已经插入了X字符串，所以删除的位置+1，O2'变成了删除起始位置为3的元素，删除长度是1。对“X123”执行O2'操作，用户1本地的字符串变成“X12”。
3. 用户2浏览器中字符串先变成“12”，O1操作到达用户2的浏览器之后，和O2发生转换`O1'=Transform(O1,O2)=Insert(0,"X")`，因为O2删除的元素是从第二个位置开始的，对O1'添加元素没有影响，所以`O1'=O1`。对“12”执行O1'操作，用户2本地的字符串变成“X12”。

总之，OT通过**转换方法**产生一个新的操作，使当前字符串应用到转换算法之后两个浏览器的内容保持一致。

## 3.2 撤销操作的基本思想

![img](https://pic1.zhimg.com/80/v2-0c04838e9df372864c90854ea8acc14c_720w.webp)

如上图，两个用户在浏览器中打开了同一个在线文档，文档的初始内容是“12”。

1. 用户2执行操作`O1=Insert(2,"Y")`，在位置2插入字符串Y，用户2本地的字符串变成了“12Y”。
2. 用户2的操作到达用户1的浏览器，此时用户1没有做任何操作，所以O1原样执行，用户1浏览器的字符串也变成了“12Y”。
3. 用户1执行操作`O2=Insert(0,"X")`，在位置0插入字符串“X”，用户1本地的字符串变成了“X12Y”。
4. 用户1的操作到达用户2的浏览器，此时用户2没有其他操作，所以O2原样执行，用户2浏览器的字符串变成了“X12Y”。
5. 随后用户2执行撤销操作，此时撤销操作表示为`Undo(O1)=T(!O1,O2) = Delete(3)`。!O1是O1的逆向操作，本来应该是Delete(2)，因为O2在字符串中增加了一个字符，所以此时的撤销操作是Delete(3)，删除位置是3的元素，所以用户2本地的字符串变成了“X12”。
6. 用户2的操作到达用户1的浏览器，用户1执行Delete(3)之后本地的字符串也变成了“X12”。

总之，撤销操作需要正确执行自己操作的逆向操作，还要保留其他客户端传来的执行结果。

## 3.3 操作压缩的基本思想

![img](https://pic2.zhimg.com/80/v2-8b6fa6d0cf83eb6a65d86ad5cc77ed85_720w.webp)

# 4. OT算法的实战案例

# 5. 相关链接

[1][https://en.wikipedia.org/wiki/Operational_transformation](https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Operational_transformation)
[2][https://www3.ntu.edu.sg/scse/staff/czsun/projects/otfaq/](https://link.zhihu.com/?target=https%3A//www3.ntu.edu.sg/scse/staff/czsun/projects/otfaq/)
[3][https://github.com/share/sharedb](https://link.zhihu.com/?target=https%3A//github.com/share/sharedb) [4][https://www.shangmayuan.com/a/eaa92ee4dce945f4b733a372.html](https://link.zhihu.com/?target=https%3A//www.shangmayuan.com/a/eaa92ee4dce945f4b733a372.html) [5][https://github.com/Operational-](https://link.zhihu.com/?target=https%3A//github.com/Operational-Transformation/ot.js)

# 6.Writer中的OT

